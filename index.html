<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
    // =============================================
    // CONFIGURACI√ìN DE SUPABASE - REEMPLAZA CON TUS DATOS
    // =============================================
    // Mejor manejo de errores en loadProductsFromSupabase
async function loadProductsFromSupabase() {
    try {
        const { data, error } = await supabase
            .from('products')
            .select('*')
            .eq('active', true);

        if (error) {
            console.error('Error de Supabase:', error);
            return false;
        }
        
        if (data && data.length > 0) {
            products = data;
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error inesperado:', error);
        return false;
    }
}
    const supabaseUrl = 'https://snicbcekapbxkgmhekgg.supabase.co'; // Ej: 'https://xyzabc.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuaWNiY2VrYXBieGtnbWhla2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTAyNDcsImV4cCI6MjA3ODEyNjI0N30.mah6bQou0Ztw2MdC4I7pONf1aGrli64DFpvs6bKiUM0';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // =============================================
    // DATOS INICIALES
    // =============================================
    let products = [];
    let categories = [];
    let cart = [];
    let storeSettings = {
        storeName: "Tienda Online",
        whatsappNumber: "+1234567890"
    };
    let contactInfo = {
        description: "Tu destino para compras en l√≠nea de calidad. Ofrecemos los mejores productos con entrega r√°pida y servicio al cliente excepcional.",
        phones: [
            { id: 1, label: "Ventas", number: "+1 234 567 890" }
        ],
        emails: [
            { id: 1, label: "General", address: "info@tiendaonline.com" }
        ],
        addresses: [
            { id: 1, label: "Oficina Principal", text: "Calle Principal 123, Ciudad" }
        ]
    };
    let bannerData = {
        title: "Ofertas Especiales de Verano",
        description: "Hasta 50% de descuento en productos seleccionados",
        image: "https://images.unsplash.com/photo-1607082350899-7e105aa886ae?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80"
    };

    // =============================================
    // ELEMENTOS DEL DOM
    // =============================================
    const productsContainer = document.getElementById('products-container');
    const categoriesContainer = document.getElementById('categories-container');
    const cartCount = document.getElementById('cart-count');
    const cartIcon = document.getElementById('cart-icon');
    const cartModal = document.getElementById('cart-modal');
    const closeCart = document.getElementById('close-cart');
    const continueShopping = document.getElementById('continue-shopping');
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const checkoutWhatsApp = document.getElementById('checkout-whatsapp');
    const adminLink = document.getElementById('admin-link');
    const adminPanel = document.getElementById('admin-panel');
    const logoutAdmin = document.getElementById('logout-admin');
    const adminTabs = document.querySelectorAll('.admin-tab');
    const adminTabContents = document.querySelectorAll('.admin-tab-content');
    const productForm = document.getElementById('product-form');
    const adminProductList = document.getElementById('admin-product-list');
    const storeNameElement = document.getElementById('store-name');
    const storeNameInput = document.getElementById('store-name-input');
    const whatsappNumberInput = document.getElementById('whatsapp-number');
    const settingsForm = document.getElementById('settings-form');
    const productImageInput = document.getElementById('product-image');
    const productImagePreview = document.getElementById('product-image-preview');
    const bannerForm = document.getElementById('banner-form');
    const bannerImageInput = document.getElementById('banner-image');
    const bannerImagePreview = document.getElementById('banner-image-preview');
    const bannerTitleInput = document.getElementById('banner-title');
    const bannerDescriptionInput = document.getElementById('banner-description');
    const currentBannerPreview = document.getElementById('current-banner-preview');
    const bannerSlide = document.getElementById('banner-slide');
    const bannerTitle = document.getElementById('banner-title');
    const bannerDescription = document.getElementById('banner-description');
    const productCategorySelect = document.getElementById('product-category');
    const categoryForm = document.getElementById('category-form');
    const adminCategoriesList = document.getElementById('admin-categories-list');
    const contactDescription = document.getElementById('contact-description');
    const contactToolbar = document.getElementById('contact-toolbar');
    const phoneForm = document.getElementById('phone-form');
    const phonesList = document.getElementById('phones-list');
    const emailForm = document.getElementById('email-form');
    const emailsList = document.getElementById('emails-list');
    const addressForm = document.getElementById('address-form');
    const addressesList = document.getElementById('addresses-list');
    const saveContactButton = document.getElementById('save-contact');
    const footerDescription = document.getElementById('footer-description');
    const footerContactInfo = document.getElementById('footer-contact-info');
    const footerStoreName = document.getElementById('footer-store-name');
    const footerCopyright = document.getElementById('footer-copyright');

    // =============================================
    // FUNCIONES DE SUPABASE - SINCRONIZACI√ìN
    // =============================================

    // Cargar productos desde Supabase
    async function loadProductsFromSupabase() {
        try {
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .eq('active', true);

            if (error) throw error;
            
            if (data && data.length > 0) {
                products = data;
                return true;
            }
        } catch (error) {
            console.error('‚ùå Error cargando productos:', error);
        }
        return false;
    }

    // Guardar producto en Supabase
    async function saveProductToSupabase(productData) {
        try {
            // Preparar datos para Supabase
            const supabaseProduct = {
                name: productData.name,
                price: parseFloat(productData.price),
                description: productData.description,
                category: productData.category,
                image: productData.image,
                colors: Array.isArray(productData.colors) ? productData.colors.join(', ') : productData.colors,
                active: true
            };

            // Si tiene ID, es una actualizaci√≥n
            if (productData.id) {
                supabaseProduct.id = productData.id;
            }

            const { data, error } = await supabase
                .from('products')
                .upsert(supabaseProduct)
                .select();

            if (error) throw error;
            console.log('‚úÖ Producto guardado en Supabase:', data);
            return data;
        } catch (error) {
            console.error('‚ùå Error guardando producto:', error);
            throw error;
        }
    }

    // Eliminar producto de Supabase
    async function deleteProductFromSupabase(productId) {
        try {
            const { error } = await supabase
                .from('products')
                .delete()
                .eq('id', productId);

            if (error) throw error;
            console.log('‚úÖ Producto eliminado de Supabase');
        } catch (error) {
            console.error('‚ùå Error eliminando producto:', error);
            throw error;
        }
    }

    // Cargar categor√≠as desde Supabase
    async function loadCategoriesFromSupabase() {
        try {
            const { data, error } = await supabase
                .from('categories')
                .select('*');

            if (error) throw error;
            
            if (data && data.length > 0) {
                categories = data;
                return true;
            }
        } catch (error) {
            console.error('‚ùå Error cargando categor√≠as:', error);
        }
        return false;
    }

    // Guardar categor√≠a en Supabase
    async function saveCategoryToSupabase(categoryData) {
        try {
            const { data, error } = await supabase
                .from('categories')
                .upsert(categoryData)
                .select();

            if (error) throw error;
            return data;
        } catch (error) {
            console.error('‚ùå Error guardando categor√≠a:', error);
            throw error;
        }
    }

    // Cargar configuraci√≥n de la tienda
    async function loadStoreSettingsFromSupabase() {
        try {
            const { data, error } = await supabase
                .from('store_settings')
                .select('*')
                .single();

            if (error && error.code !== 'PGRST116') throw error;
            
            if (data) {
                storeSettings = data;
                return true;
            }
        } catch (error) {
            console.error('‚ùå Error cargando configuraci√≥n:', error);
        }
        return false;
    }

    // Guardar configuraci√≥n de la tienda
    async function saveStoreSettingsToSupabase() {
        try {
            const { data, error } = await supabase
                .from('store_settings')
                .upsert({ 
                    id: 1, 
                    store_name: storeSettings.storeName,
                    whatsapp_number: storeSettings.whatsappNumber,
                    updated_at: new Date().toISOString()
                })
                .select();

            if (error) throw error;
            return data;
        } catch (error) {
            console.error('‚ùå Error guardando configuraci√≥n:', error);
            throw error;
        }
    }

    // =============================================
    // FUNCIONES ACTUALIZADAS DE GUARDADO
    // =============================================

    async function saveProduct(productData) {
        try {
            const imageInput = document.getElementById('product-image');
            
            // Usar Base64 si existe
            if (imageInput.dataset.base64) {
                productData.image = imageInput.dataset.base64;
            }

            // Guardar en Supabase
            const savedProduct = await saveProductToSupabase(productData);
            
            // Actualizar localmente
            if (productData.id) {
                const index = products.findIndex(p => p.id === productData.id);
                if (index !== -1) {
                    products[index] = { ...products[index], ...savedProduct[0] };
                }
                showNotification(`"${productData.name}" actualizado correctamente`, 'success');
            } else {
                products.push(savedProduct[0]);
                showNotification(`"${productData.name}" creado correctamente`, 'success');
            }

            renderAdminProducts();
            renderProducts();
            productForm.reset();
            productImagePreview.innerHTML = '';
            document.getElementById('save-product').textContent = 'Guardar Producto';
            document.getElementById('product-id').value = '';
            
            if (imageInput.dataset.base64) {
                delete imageInput.dataset.base64;
            }
            
        } catch (error) {
            showNotification('Error guardando producto: ' + error.message, 'error');
        }
    }

    async function deleteProduct(productId) {
        if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
            try {
                await deleteProductFromSupabase(productId);
                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    const productName = products[productIndex].name;
                    products.splice(productIndex, 1);
                    renderAdminProducts();
                    renderProducts();
                    showNotification(`"${productName}" eliminado correctamente`, 'success');
                }
            } catch (error) {
                showNotification('Error eliminando producto: ' + error.message, 'error');
            }
        }
    }

    async function saveCategory(categoryData) {
        try {
            if (categoryData.id) {
                const index = categories.findIndex(c => c.id === categoryData.id);
                if (index !== -1) {
                    categories[index] = { ...categories[index], ...categoryData };
                }
                showNotification(`"${categoryData.name}" actualizada correctamente`, 'success');
            } else {
                const newId = categoryData.name.toLowerCase().replace(/\s+/g, '-');
                
                if (categories.find(c => c.id === newId)) {
                    showNotification('Ya existe una categor√≠a con ese nombre. Por favor, elige un nombre diferente.', 'error');
                    return;
                }
                
                categoryData.id = newId;
                categories.push(categoryData);
                showNotification(`"${categoryData.name}" creada correctamente`, 'success');
            }
            
            await saveCategoryToSupabase(categoryData);
            renderAdminCategories();
            renderCategories();
            categoryForm.reset();
            document.getElementById('save-category').textContent = 'Guardar Categor√≠a';
            document.getElementById('category-id').value = '';
            
        } catch (error) {
            showNotification('Error guardando categor√≠a: ' + error.message, 'error');
        }
    }

    async function saveStoreSettings() {
        try {
            storeSettings.storeName = storeNameInput.value;
            storeSettings.whatsappNumber = whatsappNumberInput.value;
            
            await saveStoreSettingsToSupabase();
            storeNameElement.textContent = storeSettings.storeName;
            showNotification('Configuraci√≥n guardada correctamente', 'success');
        } catch (error) {
            showNotification('Error guardando configuraci√≥n: ' + error.message, 'error');
        }
    }

    // =============================================
    // CARGA INICIAL DE DATOS
    // =============================================

    async function loadAllData() {
        try {
            console.log('üîÑ Cargando datos desde Supabase...');
            
            await Promise.all([
                loadProductsFromSupabase(),
                loadCategoriesFromSupabase(),
                loadStoreSettingsFromSupabase()
            ]);

            // Si no hay productos, crear algunos de ejemplo
            if (products.length === 0) {
                await createSampleProducts();
            }

            // Si no hay categor√≠as, crear las b√°sicas
            if (categories.length === 0) {
                await createSampleCategories();
            }

            // Actualizar la interfaz
            renderCategories();
            renderProducts();
            updateStoreSettingsDisplay();
            updateBannerDisplay();
            updateContactInfoDisplay();
            
            console.log('‚úÖ Todos los datos cargados correctamente');
            
        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
        }
    }

    // Crear productos de ejemplo
    async function createSampleProducts() {
        const sampleProducts = [
            {
                name: "Smartphone Galaxy Pro",
                price: 599.99,
                description: "Tel√©fono inteligente de √∫ltima generaci√≥n con c√°mara de alta resoluci√≥n y pantalla AMOLED.",
                category: "electronics",
                image: "https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=880&q=80",
                colors: ["Negro", "Azul", "Blanco"],
                active: true
            },
            {
                name: "Auriculares Inal√°mbricos",
                price: 149.99,
                description: "Auriculares con cancelaci√≥n de ruido y sonido de alta calidad.",
                category: "electronics",
                image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80",
                colors: ["Negro", "Blanco", "Rojo"],
                active: true
            }
        ];

        for (const product of sampleProducts) {
            await saveProductToSupabase(product);
        }
        
        // Recargar productos
        await loadProductsFromSupabase();
    }

    // Crear categor√≠as de ejemplo
    async function createSampleCategories() {
        const sampleCategories = [
            { id: "electronics", name: "Electr√≥nica", color: "#6366f1" },
            { id: "beauty", name: "Belleza", color: "#f59e0b" },
            { id: "accessories", name: "Accesorios", color: "#10b981" },
            { id: "home", name: "Hogar", color: "#ef4444" }
        ];

        for (const category of sampleCategories) {
            await saveCategoryToSupabase(category);
        }
        
        // Recargar categor√≠as
        await loadCategoriesFromSupabase();
    }

    // =============================================
    // FUNCIONES EXISTENTES ACTUALIZADAS
    // =============================================

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Iniciando aplicaci√≥n con Supabase...');
        
        // Cargar todos los datos desde Supabase
        await loadAllData();
        
        updateCartCount();
        
        // Verificar si estamos en modo administrador
        if(localStorage.getItem('adminLoggedIn') === 'true') {
            showAdminPanel();
        }

        // Event listeners para subida de im√°genes
        productImageInput.addEventListener('change', handleProductImageUpload);
        bannerImageInput.addEventListener('change', handleBannerImageUpload);

        // Event listeners para el editor de texto
        contactToolbar.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON' || e.target.parentElement.tagName === 'BUTTON') {
                e.preventDefault();
                const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
                const command = button.getAttribute('data-command');
                
                if (command === 'createLink') {
                    const url = prompt('Ingresa la URL:');
                    if (url) {
                        document.execCommand(command, false, url);
                    }
                } else {
                    document.execCommand(command, false, null);
                }
                
                contactDescription.focus();
            }
        });
        
        console.log('‚úÖ Aplicaci√≥n lista con Supabase');
    });

    // Funci√≥n para manejar la subida de im√°genes de productos
    function handleProductImageUpload(event) {
        handleImageUpload(event, productImagePreview, 'product');
    }

    // Funci√≥n para manejar la subida de im√°genes de banners
    function handleBannerImageUpload(event) {
        handleImageUpload(event, bannerImagePreview, 'banner');
    }

    // Funci√≥n gen√©rica para manejar subida de im√°genes
    function handleImageUpload(event, previewElement, type) {
        const file = event.target.files[0];
        
        if (!file) return;
        
        // Validar tipo de archivo
        if (!file.type.match('image.*')) {
            showNotification('Por favor, selecciona solo archivos de imagen (JPG, PNG, GIF).', 'error');
            event.target.value = '';
            return;
        }
        
        // Validar tama√±o (2MB para productos, 5MB para banners)
        const maxSize = type === 'banner' ? 5 * 1024 * 1024 : 2 * 1024 * 1024;
        if (file.size > maxSize) {
            showNotification(`La imagen es demasiado grande. M√°ximo ${type === 'banner' ? '5MB' : '2MB'}.`, 'error');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            // Mostrar previsualizaci√≥n
            previewElement.innerHTML = `
                <img src="${e.target.result}" 
                     style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border);">
                <p style="font-size: 0.8rem; color: var(--success); margin-top: 5px;">
                    ‚úì Imagen cargada correctamente
                </p>
            `;
            
            // Guardar la imagen en Base64
            event.target.dataset.base64 = e.target.result;
        };
        
        reader.onerror = function() {
            showNotification('Error al cargar la imagen. Intenta con otra.', 'error');
            event.target.value = '';
        };
        
        reader.readAsDataURL(file);
    }

    // Renderizar categor√≠as
    function renderCategories() {
        categoriesContainer.innerHTML = '';
        
        // Agregar categor√≠a "Todos"
        const allCategory = document.createElement('div');
        allCategory.className = 'category active';
        allCategory.setAttribute('data-category', 'all');
        allCategory.textContent = 'Todos';
        allCategory.addEventListener('click', function() {
            document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            renderProducts('all');
        });
        categoriesContainer.appendChild(allCategory);
        
        // Agregar categor√≠as personalizadas
        categories.forEach(category => {
            const categoryElement = document.createElement('div');
            categoryElement.className = 'category';
            categoryElement.setAttribute('data-category', category.id);
            categoryElement.textContent = category.name;
            categoryElement.addEventListener('click', function() {
                document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                renderProducts(category.id);
            });
            categoriesContainer.appendChild(categoryElement);
        });
        
        // Actualizar selector de categor√≠as en el formulario de productos
        updateCategorySelect();
    }

    // Actualizar selector de categor√≠as en el formulario de productos
    function updateCategorySelect() {
        productCategorySelect.innerHTML = '';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            productCategorySelect.appendChild(option);
        });
    }

    // Renderizar productos
    function renderProducts(filterCategory = 'all') {
        productsContainer.innerHTML = '';
        
        const filteredProducts = filterCategory === 'all' 
            ? products 
            : products.filter(product => product.category === filterCategory);
        
        if (filteredProducts.length === 0) {
            productsContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">No hay productos en esta categor√≠a.</p>';
            return;
        }
        
        filteredProducts.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="product-image">
                <div class="product-info">
                    <h3 class="product-name">${product.name}</h3>
                    <p class="product-description">${product.description}</p>
                    <div class="product-colors">
                        ${product.colors && typeof product.colors === 'string' ? 
                            product.colors.split(',').map(color => 
                                `<div class="color" style="background-color: ${getColorCode(color.trim())}" title="${color.trim()}"></div>`
                            ).join('') : 
                            (Array.isArray(product.colors) ? 
                                product.colors.map(color => 
                                    `<div class="color" style="background-color: ${getColorCode(color)}" title="${color}"></div>`
                                ).join('') : '')
                        }
                    </div>
                    <div class="product-footer">
                        <div class="product-price">$${parseFloat(product.price).toFixed(2)}</div>
                        <button class="add-to-cart" data-id="${product.id}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;
            productsContainer.appendChild(productCard);
        });
        
        // Agregar event listeners a los botones de agregar al carrito
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', function() {
                const productId = parseInt(this.getAttribute('data-id'));
                addToCart(productId);
            });
        });
    }

    // Obtener c√≥digo de color (simplificado)
    function getColorCode(colorName) {
        const colorMap = {
            'Negro': '#000000',
            'Blanco': '#ffffff',
            'Azul': '#0000ff',
            'Rojo': '#ff0000',
            'Marr√≥n': '#8b4513',
            'Plateado': '#c0c0c0',
            'Madera': '#deb887',
            'Rosa': '#ffc0cb',
            'Dorado': '#ffd700',
            'Azul Marino': '#000080',
            'Gris': '#808080',
            'Azul Claro': '#add8e6',
            'Variados': '#cccccc'
        };
        return colorMap[colorName] || '#cccccc';
    }

    // Funciones del carrito
    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        const existingItem = cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: parseFloat(product.price),
                image: product.image,
                quantity: 1
            });
        }
        
        updateCartCount();
        saveCartToStorage();
        showNotification(`${product.name} agregado al carrito`, 'success');
    }

    function updateCartCount() {
        const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
        cartCount.textContent = totalItems;
    }

    function renderCartItems() {
        cartItems.innerHTML = '';
        
        if (cart.length === 0) {
            cartItems.innerHTML = '<p style="text-align: center; padding: 20px;">Tu carrito est√° vac√≠o</p>';
            return;
        }
        
        cart.forEach(item => {
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                <div class="cart-item-details">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">$${item.price.toFixed(2)}</div>
                    <div class="cart-item-quantity">
                        <button class="quantity-btn decrease-quantity" data-id="${item.id}">-</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-id="${item.id}">
                        <button class="quantity-btn increase-quantity" data-id="${item.id}">+</button>
                        <button class="remove-item" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            cartItems.appendChild(cartItem);
        });
        
        // Calcular y mostrar el total
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartTotal.textContent = `$${total.toFixed(2)}`;
        
        // Agregar event listeners a los controles de cantidad
        document.querySelectorAll('.decrease-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const productId = parseInt(this.getAttribute('data-id'));
                updateQuantity(productId, -1);
            });
        });
        
        document.querySelectorAll('.increase-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const productId = parseInt(this.getAttribute('data-id'));
                updateQuantity(productId, 1);
            });
        });
        
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                const productId = parseInt(this.getAttribute('data-id'));
                const newQuantity = parseInt(this.value);
                if (newQuantity < 1) {
                    this.value = 1;
                    updateQuantity(productId, 0, 1);
                } else {
                    updateQuantity(productId, 0, newQuantity);
                }
            });
        });
        
        document.querySelectorAll('.remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const productId = parseInt(this.getAttribute('data-id'));
                removeFromCart(productId);
            });
        });
    }

    function updateQuantity(productId, change, setQuantity = null) {
        const item = cart.find(item => item.id === productId);
        if (!item) return;
        
        if (setQuantity !== null) {
            item.quantity = setQuantity;
        } else {
            item.quantity += change;
        }
        
        if (item.quantity < 1) {
            removeFromCart(productId);
        } else {
            updateCartCount();
            renderCartItems();
            saveCartToStorage();
        }
    }

    function removeFromCart(productId) {
        const itemIndex = cart.findIndex(item => item.id === productId);
        if (itemIndex !== -1) {
            const itemName = cart[itemIndex].name;
            cart.splice(itemIndex, 1);
            updateCartCount();
            renderCartItems();
            saveCartToStorage();
            showNotification(`${itemName} eliminado del carrito`, 'success');
        }
    }

    function showNotification(message, type = 'success') {
        // Crear notificaci√≥n temporal
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        document.body.appendChild(notification);
        
        // Remover despu√©s de 3 segundos
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Funciones del panel de administraci√≥n
    function showAdminPanel() {
        // Mostrar formulario de login si no est√° autenticado
        if (localStorage.getItem('adminLoggedIn') !== 'true') {
            const username = prompt('Usuario:');
            const password = prompt('Contrase√±a:');
            
            if (username === 'admin' && password === 'ventas') {
                localStorage.setItem('adminLoggedIn', 'true');
            } else {
                alert('Credenciales incorrectas');
                return;
            }
        }
        
        // Mostrar panel de administraci√≥n
        document.querySelectorAll('section:not(.admin-panel)').forEach(section => {
            section.style.display = 'none';
        });
        adminPanel.style.display = 'block';
        
        // Cargar datos en el panel
        renderAdminProducts();
        renderAdminCategories();
        renderContactInfoForms();
        updateStoreSettingsDisplay();
        loadBannerFormData();
    }

    function hideAdminPanel() {
        document.querySelectorAll('section').forEach(section => {
            section.style.display = 'block';
        });
        adminPanel.style.display = 'none';
        localStorage.setItem('adminLoggedIn', 'false');
    }

    function renderAdminProducts() {
        adminProductList.innerHTML = '';
        
        if (products.length === 0) {
            adminProductList.innerHTML = '<p>No hay productos registrados.</p>';
            return;
        }
        
        products.forEach(product => {
            const productItem = document.createElement('div');
            productItem.className = 'product-list-item';
            productItem.innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="product-list-image">
                <div class="product-list-details">
                    <div class="product-list-name">${product.name}</div>
                    <div class="product-list-price">$${parseFloat(product.price).toFixed(2)}</div>
                    <div class="product-list-category">${product.category}</div>
                </div>
                <div class="product-list-actions">
                    <button class="btn btn-edit edit-product" data-id="${product.id}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-delete delete-product" data-id="${product.id}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
            adminProductList.appendChild(productItem);
        });
        
        // Agregar event listeners a los botones de editar y eliminar
        document.querySelectorAll('.edit-product').forEach(button => {
            button.addEventListener('click', function() {
                const productId = parseInt(this.getAttribute('data-id'));
                editProduct(productId);
            });
        });
        
        document.querySelectorAll('.delete-product').forEach(button => {
            button.addEventListener('click', function() {
                const productId = parseInt(this.getAttribute('data-id'));
                deleteProduct(productId);
            });
        });
    }

    function renderAdminCategories() {
        adminCategoriesList.innerHTML = '';
        
        if (categories.length === 0) {
            adminCategoriesList.innerHTML = '<p>No hay categor√≠as registradas.</p>';
            return;
        }
        
        categories.forEach(category => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'item-card';
            categoryItem.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${category.name}</div>
                    <div class="item-details">ID: ${category.id}</div>
                </div>
                <div class="item-actions">
                    <button class="btn btn-edit btn-sm edit-category" data-id="${category.id}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-delete btn-sm delete-category" data-id="${category.id}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
            adminCategoriesList.appendChild(categoryItem);
        });
        
        // Agregar event listeners a los botones de editar y eliminar
        document.querySelectorAll('.edit-category').forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-id');
                editCategory(categoryId);
            });
        });
        
        document.querySelectorAll('.delete-category').forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-id');
                deleteCategory(categoryId);
            });
        });
    }

    function editProduct(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('product-id').value = product.id;
        document.getElementById('product-name').value = product.name;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-description').value = product.description;
        document.getElementById('product-category').value = product.category;
        document.getElementById('product-colors').value = 
            typeof product.colors === 'string' ? product.colors : product.colors.join(', ');
        
        // Manejar imagen existente
        if (product.image.startsWith('data:image')) {
            productImagePreview.innerHTML = `<img src="${product.image}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
            productImageInput.dataset.base64 = product.image;
        } else {
            productImagePreview.innerHTML = `<img src="${product.image}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                                    <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 5px;">
                                        Imagen actual (URL)
                                    </p>`;
        }
        
        document.getElementById('save-product').textContent = 'Actualizar Producto';
        document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
    }

    function editCategory(categoryId) {
        const category = categories.find(c => c.id === categoryId);
        if (!category) return;
        
        document.getElementById('category-id').value = category.id;
        document.getElementById('category-name').value = category.name;
        document.getElementById('category-color').value = category.color;
        
        document.getElementById('save-category').textContent = 'Actualizar Categor√≠a';
        document.getElementById('category-form').scrollIntoView({ behavior: 'smooth' });
    }

    function deleteCategory(categoryId) {
        if (confirm('¬øEst√°s seguro de que quieres eliminar esta categor√≠a?')) {
            const productsInCategory = products.filter(p => p.category === categoryId);
            if (productsInCategory.length > 0) {
                showNotification('No puedes eliminar una categor√≠a que tiene productos asignados. Primero mueve o elimina los productos.', 'error');
                return;
            }
            
            const categoryIndex = categories.findIndex(c => c.id === categoryId);
            if (categoryIndex !== -1) {
                const categoryName = categories[categoryIndex].name;
                categories.splice(categoryIndex, 1);
                saveCategoryToSupabase({ id: categoryId, active: false }); // Marcar como inactiva en Supabase
                renderAdminCategories();
                renderCategories();
                showNotification(`"${categoryName}" eliminada correctamente`, 'success');
            }
        }
    }

    // =============================================
    // FUNCIONES RESTANTES (MANTENER SIN CAMBIOS)
    // =============================================

    function renderContactInfoForms() {
        contactDescription.innerHTML = contactInfo.description;
        renderPhonesList();
        renderEmailsList();
        renderAddressesList();
    }

    function renderPhonesList() {
        phonesList.innerHTML = '';
        
        if (contactInfo.phones.length === 0) {
            phonesList.innerHTML = '<p>No hay n√∫meros de tel√©fono registrados.</p>';
            return;
        }
        
        contactInfo.phones.forEach(phone => {
            const phoneItem = document.createElement('div');
            phoneItem.className = 'item-card';
            phoneItem.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${phone.label}</div>
                    <div class="item-details">${phone.number}</div>
                </div>
                <div class="item-actions">
                    <button class="btn btn-delete btn-sm delete-phone" data-id="${phone.id}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
            phonesList.appendChild(phoneItem);
        });
        
        document.querySelectorAll('.delete-phone').forEach(button => {
            button.addEventListener('click', function() {
                const phoneId = parseInt(this.getAttribute('data-id'));
                deletePhone(phoneId);
            });
        });
    }

    function renderEmailsList() {
        emailsList.innerHTML = '';
        
        if (contactInfo.emails.length === 0) {
            emailsList.innerHTML = '<p>No hay direcciones de email registradas.</p>';
            return;
        }
        
        contactInfo.emails.forEach(email => {
            const emailItem = document.createElement('div');
            emailItem.className = 'item-card';
            emailItem.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${email.label}</div>
                    <div class="item-details">${email.address}</div>
                </div>
                <div class="item-actions">
                    <button class="btn btn-delete btn-sm delete-email" data-id="${email.id}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
            emailsList.appendChild(emailItem);
        });
        
        document.querySelectorAll('.delete-email').forEach(button => {
            button.addEventListener('click', function() {
                const emailId = parseInt(this.getAttribute('data-id'));
                deleteEmail(emailId);
            });
        });
    }

    function renderAddressesList() {
        addressesList.innerHTML = '';
        
        if (contactInfo.addresses.length === 0) {
            addressesList.innerHTML = '<p>No hay direcciones registradas.</p>';
            return;
        }
        
        contactInfo.addresses.forEach(address => {
            const addressItem = document.createElement('div');
            addressItem.className = 'item-card';
            addressItem.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${address.label}</div>
                    <div class="item-details">${address.text}</div>
                </div>
                <div class="item-actions">
                    <button class="btn btn-delete btn-sm delete-address" data-id="${address.id}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
            addressesList.appendChild(addressItem);
        });
        
        document.querySelectorAll('.delete-address').forEach(button => {
            button.addEventListener('click', function() {
                const addressId = parseInt(this.getAttribute('data-id'));
                deleteAddress(addressId);
            });
        });
    }

    function deletePhone(phoneId) {
        const phoneIndex = contactInfo.phones.findIndex(p => p.id === phoneId);
        if (phoneIndex !== -1) {
            contactInfo.phones.splice(phoneIndex, 1);
            renderPhonesList();
            showNotification('Tel√©fono eliminado correctamente', 'success');
        }
    }

    function deleteEmail(emailId) {
        const emailIndex = contactInfo.emails.findIndex(e => e.id === emailId);
        if (emailIndex !== -1) {
            contactInfo.emails.splice(emailIndex, 1);
            renderEmailsList();
            showNotification('Email eliminado correctamente', 'success');
        }
    }

    function deleteAddress(addressId) {
        const addressIndex = contactInfo.addresses.findIndex(a => a.id === addressId);
        if (addressIndex !== -1) {
            contactInfo.addresses.splice(addressIndex, 1);
            renderAddressesList();
            showNotification('Direcci√≥n eliminada correctamente', 'success');
        }
    }

    function saveContactInfo() {
        contactInfo.description = contactDescription.innerHTML;
        saveContactInfoToStorage();
        updateContactInfoDisplay();
        showNotification('Informaci√≥n de contacto guardada correctamente', 'success');
    }

    function addPhone(phoneData) {
        const newId = contactInfo.phones.length > 0 ? Math.max(...contactInfo.phones.map(p => p.id)) + 1 : 1;
        phoneData.id = newId;
        contactInfo.phones.push(phoneData);
        renderPhonesList();
        phoneForm.reset();
        showNotification('Tel√©fono agregado correctamente', 'success');
    }

    function addEmail(emailData) {
        const newId = contactInfo.emails.length > 0 ? Math.max(...contactInfo.emails.map(e => e.id)) + 1 : 1;
        emailData.id = newId;
        contactInfo.emails.push(emailData);
        renderEmailsList();
        emailForm.reset();
        showNotification('Email agregado correctamente', 'success');
    }

    function addAddress(addressData) {
        const newId = contactInfo.addresses.length > 0 ? Math.max(...contactInfo.addresses.map(a => a.id)) + 1 : 1;
        addressData.id = newId;
        contactInfo.addresses.push(addressData);
        renderAddressesList();
        addressForm.reset();
        showNotification('Direcci√≥n agregada correctamente', 'success');
    }

    function loadBannerFormData() {
        bannerTitleInput.value = bannerData.title;
        bannerDescriptionInput.value = bannerData.description;
    }

    function updateContactInfoDisplay() {
        footerDescription.innerHTML = contactInfo.description;
        footerContactInfo.innerHTML = '';
        
        contactInfo.phones.forEach(phone => {
            const phoneItem = document.createElement('li');
            phoneItem.innerHTML = `<i class="fas fa-phone"></i> ${phone.label}: ${phone.number}`;
            footerContactInfo.appendChild(phoneItem);
        });
        
        contactInfo.emails.forEach(email => {
            const emailItem = document.createElement('li');
            emailItem.innerHTML = `<i class="fas fa-envelope"></i> ${email.label}: ${email.address}`;
            footerContactInfo.appendChild(emailItem);
        });
        
        contactInfo.addresses.forEach(address => {
            const addressItem = document.createElement('li');
            addressItem.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${address.label}: ${address.text}`;
            footerContactInfo.appendChild(addressItem);
        });
        
        footerStoreName.textContent = storeSettings.storeName;
        footerCopyright.textContent = storeSettings.storeName;
    }

    function updateStoreSettingsDisplay() {
        storeNameElement.textContent = storeSettings.storeName;
        storeNameInput.value = storeSettings.storeName;
        whatsappNumberInput.value = storeSettings.whatsappNumber;
    }

    function updateBannerDisplay() {
        bannerSlide.style.backgroundImage = `url('${bannerData.image}')`;
        bannerTitle.textContent = bannerData.title;
        bannerDescription.textContent = bannerData.description;
        
        currentBannerPreview.innerHTML = `
            <div style="background-image: url('${bannerData.image}'); background-size: cover; background-position: center; height: 150px; border-radius: var(--radius); margin-bottom: 10px;"></div>
            <h5>${bannerData.title}</h5>
            <p>${bannerData.description}</p>
        `;
    }

    function saveBanner(bannerData) {
        const imageInput = document.getElementById('banner-image');
        
        if (imageInput.dataset.base64) {
            bannerData.image = imageInput.dataset.base64;
        } else if (imageInput.value) {
            bannerData.image = imageInput.value;
        } else {
            showNotification('Por favor, selecciona una imagen para el banner.', 'error');
            return;
        }
        
        bannerData.title = bannerTitleInput.value;
        bannerData.description = bannerDescriptionInput.value;
        
        localStorage.setItem('storeBanner', JSON.stringify(bannerData));
        updateBannerDisplay();
        showNotification('Banner actualizado correctamente', 'success');
        
        bannerForm.reset();
        bannerImagePreview.innerHTML = '';
        delete imageInput.dataset.base64;
    }

    function loadBannerFromStorage() {
        const savedBanner = localStorage.getItem('storeBanner');
        if (savedBanner) {
            bannerData = JSON.parse(savedBanner);
        }
    }

    function loadStoreSettings() {
        const savedSettings = localStorage.getItem('storeSettings');
        if (savedSettings) {
            storeSettings = JSON.parse(savedSettings);
        }
        updateStoreSettingsDisplay();
    }

    function loadProductsFromStorage() {
        const savedProducts = localStorage.getItem('storeProducts');
        if (savedProducts) {
            products = JSON.parse(savedProducts);
            renderProducts();
        }
    }

    function loadCategoriesFromStorage() {
        const savedCategories = localStorage.getItem('storeCategories');
        if (savedCategories) {
            categories = JSON.parse(savedCategories);
            renderCategories();
        }
    }

    function loadContactInfoFromStorage() {
        const savedContactInfo = localStorage.getItem('storeContactInfo');
        if (savedContactInfo) {
            contactInfo = JSON.parse(savedContactInfo);
            updateContactInfoDisplay();
        }
    }

    function saveCartToStorage() {
        localStorage.setItem('storeCart', JSON.stringify(cart));
    }

    function loadCartFromStorage() {
        const savedCart = localStorage.getItem('storeCart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
            updateCartCount();
        }
    }

    // Cargar carrito desde localStorage al iniciar
    loadCartFromStorage();

    // Event Listeners
    cartIcon.addEventListener('click', function() {
        renderCartItems();
        cartModal.classList.add('active');
    });

    closeCart.addEventListener('click', function() {
        cartModal.classList.remove('active');
    });

    continueShopping.addEventListener('click', function() {
        cartModal.classList.remove('active');
    });

    checkoutWhatsApp.addEventListener('click', function() {
        if (cart.length === 0) {
            showNotification('Tu carrito est√° vac√≠o', 'error');
            return;
        }
        
        let message = `Hola, me gustar√≠a realizar el siguiente pedido:\n\n`;
        
        cart.forEach(item => {
            message += `‚Ä¢ ${item.name} - Cantidad: ${item.quantity} - $${(item.price * item.quantity).toFixed(2)}\n`;
        });
        
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        message += `\nTotal: $${total.toFixed(2)}`;
        
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${storeSettings.whatsappNumber}?text=${encodedMessage}`;
        
        window.open(whatsappUrl, '_blank');
    });

    adminLink.addEventListener('click', function(e) {
        e.preventDefault();
        showAdminPanel();
    });

    logoutAdmin.addEventListener('click', function() {
        hideAdminPanel();
    });

    adminTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            adminTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            adminTabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
        });
    });

    productForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const productData = {
            id: document.getElementById('product-id').value ? parseInt(document.getElementById('product-id').value) : null,
            name: document.getElementById('product-name').value,
            price: parseFloat(document.getElementById('product-price').value),
            description: document.getElementById('product-description').value,
            category: document.getElementById('product-category').value,
            colors: document.getElementById('product-colors').value.split(',').map(color => color.trim()).filter(color => color !== '')
        };
        
        saveProduct(productData);
    });

    categoryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const categoryData = {
            id: document.getElementById('category-id').value || null,
            name: document.getElementById('category-name').value,
            color: document.getElementById('category-color').value
        };
        
        saveCategory(categoryData);
    });

    bannerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveBanner(bannerData);
    });

    phoneForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const phoneData = {
            label: document.getElementById('phone-label').value,
            number: document.getElementById('phone-number').value
        };
        
        addPhone(phoneData);
    });

    emailForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const emailData = {
            label: document.getElementById('email-label').value,
            address: document.getElementById('email-address').value
        };
        
        addEmail(emailData);
    });

    addressForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const addressData = {
            label: document.getElementById('address-label').value,
            text: document.getElementById('address-text').value
        };
        
        addAddress(addressData);
    });

    saveContactButton.addEventListener('click', function() {
        saveContactInfo();
    });

    settingsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveStoreSettings();
    });

    cartModal.addEventListener('click', function(e) {
        if (e.target === cartModal) {
            cartModal.classList.remove('active');
        }
    });
</script>